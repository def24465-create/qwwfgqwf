--[[   
    FINAL MERGED VERSION WITH 7 EXTRA HERBS + KEY SYSTEM
    Key: ESPBYKOBAY112
    Link to get key: https://link-hub.net/1460935/swdGQCn124MP
]]--

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LP = Players.LocalPlayer
local CoreGui = game:GetService("CoreGui")
local Workspace = game:GetService("Workspace")

-- üîë Key System
local CorrectKey = "ESPBYKOBAY112"
local KeyURL = "https://link-hub.net/1460935/swdGQCn124MP"

-- ‡∏•‡∏ö GUI ‡πÄ‡∏Å‡πà‡∏≤
if CoreGui:FindFirstChild("ESP_KEY_UI") then
    CoreGui.ESP_KEY_UI:Destroy()
end
if CoreGui:FindFirstChild("ESP_UI") then
    CoreGui.ESP_UI:Destroy()
end

-- ‡∏™‡∏£‡πâ‡∏≤‡∏á Key GUI
local KeyGui = Instance.new("ScreenGui", CoreGui)
KeyGui.Name = "ESP_KEY_UI"
KeyGui.ResetOnSpawn = false

local Frame = Instance.new("Frame", KeyGui)
Frame.Size = UDim2.new(0, 300, 0, 150)
Frame.Position = UDim2.new(0.5, -150, 0.4, -75)
Frame.BackgroundColor3 = Color3.fromRGB(25,25,25)
Frame.Active = true
Frame.Draggable = true

local Title = Instance.new("TextLabel", Frame)
Title.Size = UDim2.new(1,0,0,25)
Title.Position = UDim2.new(0,0,0,0)
Title.BackgroundColor3 = Color3.fromRGB(15,15,15)
Title.Text = "Enter Key to Access ESP"
Title.TextColor3 = Color3.new(1,1,1)

local KeyBox = Instance.new("TextBox", Frame)
KeyBox.Size = UDim2.new(1,-20,0,25)
KeyBox.Position = UDim2.new(0,10,0,40)
KeyBox.PlaceholderText = "Enter Key Here"
KeyBox.TextColor3 = Color3.new(1,1,1)
KeyBox.BackgroundColor3 = Color3.fromRGB(50,50,50)

local GetKeyBtn = Instance.new("TextButton", Frame)
GetKeyBtn.Size = UDim2.new(0.5,-15,0,25)
GetKeyBtn.Position = UDim2.new(0,10,0,75)
GetKeyBtn.Text = "Get Key"
GetKeyBtn.BackgroundColor3 = Color3.fromRGB(80,0,0)
GetKeyBtn.TextColor3 = Color3.new(1,1,1)
GetKeyBtn.MouseButton1Click:Connect(function()
    warn("Go to Link to get Key: "..KeyURL)
    pcall(function() setclipboard(KeyURL) end)
end)

local SubmitBtn = Instance.new("TextButton", Frame)
SubmitBtn.Size = UDim2.new(0.5,-15,0,25)
SubmitBtn.Position = UDim2.new(0.5,5,0,75)
SubmitBtn.Text = "Submit Key"
SubmitBtn.BackgroundColor3 = Color3.fromRGB(0,80,0)
SubmitBtn.TextColor3 = Color3.new(1,1,1)

SubmitBtn.MouseButton1Click:Connect(function()
    if KeyBox.Text == CorrectKey then
        warn("Key Valid! Loading ESP...")
        KeyGui:Destroy()

        -- =============================
        -- ESP ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        -- =============================

        local ScreenGui = Instance.new("ScreenGui", CoreGui)
        ScreenGui.Name = "ESP_UI"
        ScreenGui.ResetOnSpawn = false

        local Frame = Instance.new("Frame", ScreenGui)
        Frame.Size = UDim2.new(0, 260, 0, 500)
        Frame.Position = UDim2.new(0.05, 0, 0.3, 0)
        Frame.BackgroundColor3 = Color3.fromRGB(25,25,25)
        Frame.Active = true
        Frame.Draggable = true

        local Title = Instance.new("TextLabel", Frame)
        Title.Size = UDim2.new(1, 0, 0, 25)
        Title.BackgroundColor3 = Color3.fromRGB(15,15,15)
        Title.Text = "ESP MENU"
        Title.TextColor3 = Color3.new(1,1,1)

        local ESPInputY = 35

        -- Manual ESP
        local ManualEnabled = false
        local ManualFolder = Instance.new("Folder", ScreenGui)
        ManualFolder.Name = "Manual_ESP"

        local manualList = {
            "Copper Body Formula","Beast Soul","Book of Life and Death",
            "Earth Flame Manual","Journey to the West","Star Reaving Scripture",
            "Lotus Sutra","Rising Dragon","Steel Body Formula",
            "Verdant Wind Manual","Verdant Wind Scripture","Soul Shedding",
            "Qi Condensation Sutra","Maniac's Cultivation Tips","Nine Yang Scripture",
            "Six Yin Scripture","Mother Earth Technique","Pure Heart Skill"
        }

        local ManualToggle = Instance.new("TextButton", Frame)
        ManualToggle.Size = UDim2.new(1, -20, 0, 25)
        ManualToggle.Position = UDim2.new(0, 10, 0, ESPInputY)
        ManualToggle.Text = "Manual ESP : OFF"
        ManualToggle.BackgroundColor3 = Color3.fromRGB(80,0,0)
        ManualToggle.TextColor3 = Color3.new(1,1,1)
        ESPInputY += 35

        ManualToggle.MouseButton1Click:Connect(function()
            ManualEnabled = not ManualEnabled
            ManualToggle.Text = "Manual ESP : "..(ManualEnabled and "ON" or "OFF")
            ManualToggle.BackgroundColor3 = ManualEnabled and Color3.fromRGB(0,80,0) or Color3.fromRGB(80,0,0)
        end)

        local function CreateManualESP(obj)
            if not obj then return end
            local bb = Instance.new("BillboardGui", ManualFolder)
            bb.Adornee = obj
            bb.Size = UDim2.new(0,120,0,28)
            bb.AlwaysOnTop = true
            bb.MaxDistance = 100000

            local label = Instance.new("TextLabel", bb)
            label.Size = UDim2.new(1,0,1,0)
            label.BackgroundTransparency = 1
            label.TextColor3 = Color3.fromRGB(255,255,0)
            label.Font = Enum.Font.SourceSansBold
            label.TextSize = 13
            label.TextStrokeTransparency = 0.3
            label.Text = obj.Name

            local hl = Instance.new("Highlight", ManualFolder)
            hl.Adornee = obj
            hl.FillTransparency = 0.7
            hl.OutlineTransparency = 0
            hl.OutlineColor = Color3.fromRGB(255,255,0)
        end

        task.spawn(function()
            while true do
                if ManualEnabled then
                    for _,name in ipairs(manualList) do
                        local obj = Workspace:FindFirstChild(name)
                        if obj and not ManualFolder:FindFirstChild(name) then
                            CreateManualESP(obj)
                        end
                    end
                else
                    for _,v in pairs(ManualFolder:GetChildren()) do v:Destroy() end
                end
                task.wait(0.5)
            end
        end)

        -- Age Filter
        local AgeButton = Instance.new("TextButton", Frame)
        AgeButton.Size = UDim2.new(1, -20, 0, 25)
        AgeButton.Position = UDim2.new(0, 10, 0, ESPInputY)
        AgeButton.Text = "Age Filter : OFF"
        AgeButton.BackgroundColor3 = Color3.fromRGB(50,50,100)
        AgeButton.TextColor3 = Color3.new(1,1,1)
        ESPInputY += 35

        local AgeSequence = {
            {}, {1,10,100}, {10,100}, {10,100,1000}, {100,1000}
        }
        local AgeSeqIndex = 1
        local AgeSelected = {}

        AgeButton.MouseButton1Click:Connect(function()
            AgeSeqIndex = AgeSeqIndex % #AgeSequence + 1
            AgeSelected = AgeSequence[AgeSeqIndex]
            AgeButton.Text = (#AgeSelected == 0 and "Age Filter : OFF")
                or ("Age Filter : ["..table.concat(AgeSelected,",").."]")
        end)

        -- Herbs ESP + Extra Herbs
        local HerbsEnabled = false
        local HerbFolder = Instance.new("Folder", ScreenGui)
        HerbFolder.Name = "Herb_ESP"

        local HerbsToggle = Instance.new("TextButton", Frame)
        HerbsToggle.Size = UDim2.new(1, -20, 0, 25)
        HerbsToggle.Position = UDim2.new(0, 10, 0, ESPInputY)
        HerbsToggle.Text = "Herbs ESP : OFF"
        HerbsToggle.BackgroundColor3 = Color3.fromRGB(80,0,0)
        HerbsToggle.TextColor3 = Color3.new(1,1,1)
        ESPInputY += 35

        HerbsToggle.MouseButton1Click:Connect(function()
            HerbsEnabled = not HerbsEnabled
            HerbsToggle.Text = "Herbs ESP : "..(HerbsEnabled and "ON" or "OFF")
            HerbsToggle.BackgroundColor3 = HerbsEnabled and Color3.fromRGB(0,80,0) or Color3.fromRGB(80,0,0)
        end)

        local ExtraHerbsToggles = {
            ["Soul Berries"] = false,
            ["Extreme Yang Grass"] = false,
            ["Extreme Yin Growth"] = false,
            ["Immortal Peach"] = false,
            ["Ginseng"] = false,
            ["Soothing Soul Root"] = false,
            ["Sorrowful Poison Drip"] = false
        }

        local function GetRealHerbName(name)
            if name == "Soul Berries" then
                return "Leaves"
            end
            if name == "Extreme Yin Growth" then
                return "WideFrondShrub_2"
            end
            return name
        end

        for name,_ in pairs(ExtraHerbsToggles) do
            local toggle = Instance.new("TextButton", Frame)
            toggle.Size = UDim2.new(1, -20, 0, 25)
            toggle.Position = UDim2.new(0, 10, 0, ESPInputY)
            toggle.Text = name.." ESP : OFF"
            toggle.BackgroundColor3 = Color3.fromRGB(80,0,0)
            toggle.TextColor3 = Color3.new(1,1,1)
            ESPInputY += 35

            toggle.MouseButton1Click:Connect(function()
                ExtraHerbsToggles[name] = not ExtraHerbsToggles[name]
                toggle.Text = name.." ESP : "..(ExtraHerbsToggles[name] and "ON" or "OFF")
                toggle.BackgroundColor3 = ExtraHerbsToggles[name] and Color3.fromRGB(0,80,0) or Color3.fromRGB(80,0,0)
            end)
        end

        local HerbCache = {}

        local function GetAge(inst)
            local prompt = inst:FindFirstChild("ProximityPrompt")
            if prompt and prompt.ObjectText then
                local num = tonumber(string.match(prompt.ObjectText, "(%d+)%-%s*Year"))
                if num then return num end
            end
            if inst.Name == "WideFrondShrub_2" and inst.Parent then
                local p2 = inst.Parent:FindFirstChild("ProximityPrompt")
                if p2 and p2.ObjectText then
                    local num = tonumber(string.match(p2.ObjectText, "(%d+)%-%s*Year"))
                    if num then return num end
                end
            end
            return nil
        end

        function ShouldShowHerb(part, age)
            for extraName,state in pairs(ExtraHerbsToggles) do
                if state and part.Name == GetRealHerbName(extraName) then
                    return true
                end
            end
            if not HerbsEnabled then return false end
            if #AgeSelected == 0 then return true end
            for _,v in ipairs(AgeSelected) do
                if age == v then return true end
            end
            return false
        end

        local function CreateHerbEntry(part)
            if HerbCache[part] then return end
            local bb = Instance.new("BillboardGui", HerbFolder)
            bb.Size = UDim2.new(0,120,0,28)
            bb.AlwaysOnTop = true
            bb.MaxDistance = 10000
            bb.Adornee = part

            local label = Instance.new("TextLabel", bb)
            label.Size = UDim2.new(1,0,1,0)
            label.BackgroundTransparency = 1
            label.TextColor3 = Color3.new(1,1,1)
            label.Font = Enum.Font.SourceSansBold
            label.TextSize = 13
            label.TextStrokeTransparency = 0.3

            local hl = Instance.new("Highlight", HerbFolder)
            hl.Adornee = part
            hl.FillTransparency = 0.7
            hl.OutlineTransparency = 0

            HerbCache[part] = {bb = bb, label = label, hl = hl, age = nil}
        end

        RunService.RenderStepped:Connect(function()
            local Herbs = Workspace:FindFirstChild("Herbs")
            if not Herbs then return end
            for _,part in ipairs(Herbs:GetDescendants()) do
                if part:IsA("BasePart") then
                    if not HerbCache[part] then
                        CreateHerbEntry(part)
                    end
                    local data = HerbCache[part]
                    data.age = GetAge(part)
                    local show = ShouldShowHerb(part, data.age)
                    data.bb.Enabled = show
                    data.hl.Enabled = show

                    local hrp = LP.Character and LP.Character:FindFirstChild("HumanoidRootPart")
                    if hrp and show then
                        local dist = math.floor((hrp.Position - part.Position).Magnitude)
                        data.label.Text = part.Name.." | "..(data.age or "?").."yr | "..dist.."m"
                    end
                end
            end
        end)

    else
        warn("Invalid Key!")
    end
end)
